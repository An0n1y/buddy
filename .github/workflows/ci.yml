name: Flutter iOS Unsigned

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  ios-unsigned:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Flutter version
        run: flutter --version
      - name: Ensure iOS project exists
        run: |
          if [ ! -d ios ]; then
            flutter create . --platforms=ios
          fi
      - name: Install dependencies
        run: flutter pub get
      - name: Analyze
        run: flutter analyze
      - name: Test (unit/widget)
        run: flutter test
      - name: Build iOS (unsigned with xcodebuild)
        run: |
          # Build the Flutter framework first
          flutter build ios --release --no-codesign || true

          # Now build with xcodebuild directly, forcing no code signing
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination generic/platform=iOS \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            clean build
      - name: Package unsigned IPA
        run: |
          APP_PATH="build/ios/iphoneos/Runner.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Runner.app not found at $APP_PATH"
            echo "Searching for .app files:"
            find build ios -name "*.app" 2>/dev/null || true
            exit 1
          fi
          mkdir -p build/ios/Payload
          cp -R "$APP_PATH" build/ios/Payload/
          cd build/ios
          zip -r Runner-unsigned.ipa Payload > /dev/null
          rm -rf Payload
      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: Runner-unsigned.ipa
          path: build/ios/Runner-unsigned.ipa
