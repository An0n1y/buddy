name: Flutter iOS Unsigned

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  ios-unsigned:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Flutter version
        run: flutter --version
      - name: Install xcbeautify (compact Xcode logs)
        run: |
          brew update
          brew install xcbeautify
      - name: Cache Flutter pub
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            **/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-
      - name: Install dependencies
        run: flutter pub get
      - name: Analyze
        run: flutter analyze
      - name: Test (unit/widget)
        run: flutter test
      - name: Preflight iOS (pods + plist)
        run: |
          cd ios
          pod install --no-repo-update | tee pod_install.log
          if grep -q "Can't merge user_target_xcconfig" pod_install.log; then
            echo "CocoaPods merge conflict detected in EXCLUDED_ARCHS"; exit 1; fi
          plutil -lint Runner/Info.plist

      - name: Build iOS app with xcodebuild (unsigned)
        run: |
          cd ios
          # Build with xcodebuild, bypassing all code signing
          set -o pipefail
          xcodebuild -quiet archive \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath ../build/ios/Runner.xcarchive \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            -allowProvisioningUpdates \
            -allowProvisioningDeviceRegistration | xcbeautify --is-ci --quiet
      - name: Package unsigned IPA
        run: |
          # The .app should be in the archive
          APP_PATH="build/ios/Runner.xcarchive/Products/Applications/Runner.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Runner.app not found at $APP_PATH"
            echo "Searching for .app files:"
            find build -name "*.app" 2>/dev/null || true
            exit 1
          fi
          mkdir -p build/ios/Payload
          cp -R "$APP_PATH" build/ios/Payload/
          cd build/ios
          zip -r Runner-unsigned.ipa Payload > /dev/null
          rm -rf Payload
      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: Runner-unsigned.ipa
          path: build/ios/Runner-unsigned.ipa
