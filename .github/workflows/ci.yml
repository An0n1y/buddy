name: Flutter iOS Unsigned IPA

on:
  push:
    branches: [main, develop]
  pull_request:

concurrency:
  group: ios-unsigned-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ios-unsigned:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Flutter version
        run: flutter --version
      # Cache Xcode DerivedData to speed subsequent builds dramatically
      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('ios/Podfile.lock') }}-${{ hashFiles('pubspec.lock') }}-${{ hashFiles('ios/Runner.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-
      - name: Install dependencies
        run: flutter pub get
      # Skip manual pod install & extra linting to keep builds fast. Flutter will manage pods as needed.
      - name: Build iOS app (Flutter, unsigned)
        run: |
          # Build the iOS app without code signing; this produces Runner.app under build/ios/iphoneos
          flutter config --no-analytics
          flutter build ios --release --no-codesign
      - name: Package unsigned IPA
        run: |
          # The .app should be produced by Flutter in build/ios/iphoneos
          APP_PATH="build/ios/iphoneos/Runner.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Runner.app not found at $APP_PATH"
            echo "Searching for .app files:"
            find build -name "*.app" 2>/dev/null || true
            exit 1
          fi
          mkdir -p build/ios/Payload
          cp -R "$APP_PATH" build/ios/Payload/
          cd build/ios
          zip -r Runner-unsigned.ipa Payload > /dev/null
          rm -rf Payload
      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: Runner-unsigned.ipa
          path: build/ios/Runner-unsigned.ipa
